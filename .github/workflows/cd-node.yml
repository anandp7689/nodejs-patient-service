name: CD Deploy Pipeline (Node Microservices)

on:
  workflow_run:
    workflows: ["CI Build Pipeline (Node Microservices)"]
    types:
      - completed

jobs:
  deploy-azure-container-apps:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: az acr login --name ${{ secrets.ACR_NAME }}

    # ✅ Deploy Patient Service (public)
    - name: Deploy Patient Service
      run: |
        az containerapp update \
          --name patient \
          --resource-group ${{ secrets.AZURE_RG }} \
          --image ${{ secrets.REGISTRY }}/patient-service:latest \
          --set-env-vars REDEPLOY=$(date +%s)

    # # ✅ Deploy Appointment Service (public)
    # - name: Deploy Appointment Service
    #   run: |
    #     az containerapp update \
    #       --name appointment-app \
    #       --resource-group ${{ secrets.AZURE_RG }} \
    #       --image ${{ secrets.REGISTRY }}/appointment-service:latest \
    #       --ingress external \
    #       --target-port 3001 \
    #       --set-env-vars REDEPLOY=$(date +%s)
