name: CD Deploy Pipeline (Node Microservices - AKS + Helm)

on:
  workflow_run:
    workflows: ["CI Build Pipeline (Node Microservices)"]
    types:
      - completed

jobs:
  deploy-to-aks:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # ✅ Login to Azure
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ✅ Get AKS Credentials
    - name: Get AKS Credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ secrets.AZURE_RG }} \
          --name ${{ secrets.AKS_NAME }} \
          --overwrite-existing

    # ✅ Helm install (if not installed)
    - name: Install Helm
      run: sudo snap install helm --classic

    # ✅ Deploy patient-service via Helm
    - name: Deploy Patient Service with Helm
      run: |
        helm upgrade --install patient-service ./helm/patient-service \
          --set image.repository=${{ secrets.REGISTRY }}/patient-service \
          --set image.tag=latest \
          --set service.port=3000

    # ✅ Deploy appointment-service via Helm
    - name: Deploy Appointment Service with Helm
      run: |
        helm upgrade --install appointment-service ./helm/appointment-service \
          --set image.repository=${{ secrets.REGISTRY }}/appointment-service \
          --set image.tag=latest \
          --set service.port=3001
